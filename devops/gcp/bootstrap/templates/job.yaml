apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app: "{{ .Values.conf.app_name }}-bootstrap"
  name: "{{ .Values.conf.app_name }}-bootstrap-job"
  namespace: "{{ .Release.Namespace }}"
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "100"
spec:
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      {{- with .Values.conf.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: "{{ .Values.conf.app_name }}-bootstrap-job"
          image: "{{ .Values.data.image }}"
          envFrom:
          - configMapRef:
              name: "{{ .Values.conf.app_name }}-bootstrap-job-configmap"
          - secretRef:
              name: "{{ .Values.conf.keycloak_secret_name }}"
      restartPolicy: Never
      serviceAccountName: "{{ .Values.data.serviceAccountName }}"
  backoffLimit: 3
